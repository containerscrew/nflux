name: Check Version Consistency

on:
  push:
    paths:
      - "Cargo.toml"
      - "PKGBUILD"
      - "stable.txt"
      - ".github/workflows/version.yml"
      - "**.rs"
  pull_request:

jobs:
  check-version:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check version tag and stable.txt
        run: |
          TAG_NAME=$(echo "${{ github.ref }}" | sed 's|.*/||')
          STABLE_VERSION=$(cat stable.txt | tr -d '[:space:]')
          if [ -n "$TAG_NAME" ]; then
            if [ "$TAG_NAME" != "$STABLE_VERSION" ]; then
              echo "❌ Tag version ($TAG_NAME) does not match stable.txt version ($STABLE_VERSION)"
              exit 1
            else
              echo "✅ Tag version matches stable.txt version"
            fi
          else
            echo "No tag push detected, skipping tag vs stable.txt check"
          fi

      - name: Extract version from Cargo.toml
        id: cargo
        run: |
          ver=$(grep -E '^version\s*=' nflux/Cargo.toml | head -n1 | sed 's/.*=\s*"\(.*\)".*/\1/')
          echo "cargo_version=$ver" >> $GITHUB_ENV

      - name: Extract version from PKGBUILD
        id: pkgbuild
        run: |
          ver=$(grep -E '^pkgver=' packaging/PKGBUILD | head -n1 | sed 's/pkgver=//')
          echo "pkg_version=$ver" >> $GITHUB_ENV

      - name: Extract version from stable.txt
        id: stable
        run: |
          ver=$(cat stable.txt | tr -d '[:space:]')
          echo "stable_version=$ver" >> $GITHUB_ENV

      - name: Compare versions
        run: |
          echo "Cargo.toml:   ${cargo_version}"
          echo "PKGBUILD:     ${pkg_version}"
          echo "stable.txt:   ${stable_version}"

          if [ "$cargo_version" != "$pkg_version" ] || [ "$cargo_version" != "$stable_version" ]; then
            echo "❌ Version mismatch detected"
            exit 1
          fi

          echo "✅ Versions match"

        env:
          CARGO_VERSION: ${{ steps.cargo.outputs.version }}
          PKGBUILD_VERSION: ${{ steps.pkgbuild.outputs.version }}
          STABLE_VERSION: ${{ steps.stable.outputs.version }}
