name: Check Version Consistency

on:
  push:
    # paths:
    #   - "Cargo.toml"
    #   - "PKGBUILD"
    #   - "stable.txt"
    #   - ".github/workflows/check-version.yml"
  pull_request:

jobs:
  check-version:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Extract version from Cargo.toml
        id: cargo
        run: |
          ver=$(grep -E '^version\s*=' nflux/Cargo.toml | head -n1 | sed 's/.*=\s*"\(.*\)".*/\1/')
          echo "cargo_version=$ver" >> $GITHUB_ENV

      - name: Extract version from PKGBUILD
        id: pkgbuild
        run: |
          ver=$(grep -E '^pkgver=' packaging/PKGBUILD | head -n1 | sed 's/pkgver=//')
          echo "pkg_version=$ver" >> $GITHUB_ENV

      - name: Extract version from stable.txt
        id: stable
        run: |
          ver=$(cat stable.txt | tr -d '[:space:]')
          echo "stable_version=$ver" >> $GITHUB_ENV

      - name: Compare versions
        run: |
          echo "Cargo.toml:   ${cargo_version}"
          echo "PKGBUILD:     ${pkg_version}"
          echo "stable.txt:   ${stable_version}"

          if [ "$cargo_version" != "$pkg_version" ] || [ "$cargo_version" != "$stable_version" ]; then
            echo "❌ Version mismatch detected"
            exit 1
          fi

          echo "✅ Versions match"

        env:
          CARGO_VERSION: ${{ steps.cargo.outputs.version }}
          PKGBUILD_VERSION: ${{ steps.pkgbuild.outputs.version }}
          STABLE_VERSION: ${{ steps.stable.outputs.version }}
